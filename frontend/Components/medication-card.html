<!-- Medication Card Component -->
<div class="medication-card-component" id="medicationCard">
  <div class="card-header">
    <h3 class="card-title">
      <span class="card-icon">ðŸ’Š</span>
      Medications
      <span class="pill-count" id="pillCount">0</span>
    </h3>
    <div class="card-actions">
      <button class="btn-icon" id="addMedication" title="Add Medication">
        <span class="icon">âž•</span>
      </button>
      <button class="btn-icon" id="refreshMeds" title="Refresh">
        <span class="icon">ðŸ”„</span>
      </button>
    </div>
  </div>

  <div class="medications-content">
    <div class="medications-list" id="medicationsList">
      <!-- Medications will be dynamically populated -->
    </div>

    <div class="medication-stats">
      <div class="stat-item">
        <div class="stat-value" id="takenToday">0</div>
        <div class="stat-label">Taken Today</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="dueToday">0</div>
        <div class="stat-label">Due Today</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="adherenceRate">0%</div>
        <div class="stat-label">Adherence</div>
      </div>
    </div>
  </div>

  <div class="card-footer">
    <a href="reminders.html" class="btn-link">
      Manage Medications
      <span class="link-arrow">â†’</span>
    </a>
  </div>
</div>

<!-- Add Medication Modal -->
<div class="modal-overlay" id="medicationModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add New Medication</h3>
      <button class="btn-close" id="closeModal">Ã—</button>
    </div>
    <form class="modal-form" id="medicationForm">
      <div class="form-row">
        <div class="input-group">
          <label for="medName">Medication Name *</label>
          <input type="text" id="medName" placeholder="e.g., Metformin" required>
        </div>
        <div class="input-group">
          <label for="medDosage">Dosage *</label>
          <input type="text" id="medDosage" placeholder="e.g., 500mg" required>
        </div>
      </div>

      <div class="form-row">
        <div class="input-group">
          <label for="medFrequency">Frequency *</label>
          <select id="medFrequency" required>
            <option value="">Select frequency</option>
            <option value="once">Once daily</option>
            <option value="twice">Twice daily</option>
            <option value="thrice">Three times daily</option>
            <option value="weekly">Weekly</option>
            <option value="as_needed">As needed</option>
          </select>
        </div>
        <div class="input-group">
          <label for="medTime">Time *</label>
          <input type="time" id="medTime" required>
        </div>
      </div>

      <div class="input-group">
        <label for="medInstructions">Instructions</label>
        <textarea id="medInstructions" placeholder="Special instructions (take with food, etc.)" rows="3"></textarea>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" id="cancelMedication">Cancel</button>
        <button type="submit" class="btn-primary">Add Medication</button>
      </div>
    </form>
  </div>
</div>

<style>
  .medication-card-component {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .medication-card-component:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 1.5rem 1rem;
    border-bottom: 1px solid var(--border-light);
  }

  .card-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
    color: var(--text-dark);
    font-size: 1.2rem;
  }

  .card-icon {
    font-size: 1.5rem;
  }

  .pill-count {
    background: var(--primary-blue);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .card-actions {
    display: flex;
    gap: 0.5rem;
  }

  .btn-icon {
    background: none;
    border: none;
    padding: 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .btn-icon:hover {
    background: var(--secondary-blue);
  }

  .medications-content {
    padding: 1.5rem;
  }

  .medications-list {
    margin-bottom: 1.5rem;
    max-height: 300px;
    overflow-y: auto;
  }

  .medication-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border: 1px solid var(--border-light);
    border-radius: 8px;
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
  }

  .medication-item:hover {
    border-color: var(--primary-blue);
    background: var(--secondary-blue);
  }

  .medication-item.taken {
    opacity: 0.6;
    background: #f8f9fa;
  }

  .medication-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-light);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .medication-checkbox.checked {
    background: var(--primary-green);
    border-color: var(--primary-green);
    color: white;
  }

  .medication-info {
    flex: 1;
  }

  .medication-name {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
  }

  .medication-details {
    display: flex;
    gap: 1rem;
    font-size: 0.9rem;
    color: var(--text-light);
  }

  .medication-time {
    color: var(--primary-blue);
    font-weight: 500;
  }

  .medication-actions {
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .medication-item:hover .medication-actions {
    opacity: 1;
  }

  .btn-small {
    padding: 0.25rem 0.5rem;
    border: 1px solid var(--border-light);
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s ease;
  }

  .btn-small:hover {
    border-color: var(--primary-blue);
    color: var(--primary-blue);
  }

  .medication-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    padding: 1rem;
    background: var(--background-light);
    border-radius: 8px;
  }

  .stat-item {
    text-align: center;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-blue);
    margin-bottom: 0.25rem;
  }

  .stat-label {
    font-size: 0.8rem;
    color: var(--text-light);
  }

  .card-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-light);
    background: var(--background-light);
  }

  .btn-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--primary-blue);
    text-decoration: none;
    font-weight: 600;
    transition: gap 0.3s ease;
  }

  .btn-link:hover {
    gap: 0.75rem;
  }

  .link-arrow {
    transition: transform 0.3s ease;
  }

  .btn-link:hover .link-arrow {
    transform: translateX(3px);
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modal-overlay.show {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-hover);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-light);
  }

  .modal-header h3 {
    margin: 0;
    color: var(--text-dark);
  }

  .btn-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: background 0.3s ease;
  }

  .btn-close:hover {
    background: var(--background-light);
  }

  .modal-form {
    padding: 1.5rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .input-group {
    margin-bottom: 1rem;
  }

  .input-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-dark);
  }

  .input-group input,
  .input-group select,
  .input-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--border-light);
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }

  .input-group input:focus,
  .input-group select:focus,
  .input-group textarea:focus {
    outline: none;
    border-color: var(--primary-blue);
  }

  .modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
  }

  .no-medications {
    text-align: center;
    padding: 2rem;
    color: var(--text-light);
  }

  .no-medications-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  /* Mobile Styles */
  @media (max-width: 768px) {
    .medication-stats {
      grid-template-columns: 1fr;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .modal-actions {
      flex-direction: column;
    }

    .card-header {
      padding: 1rem 1rem 0.5rem;
    }

    .medications-content {
      padding: 1rem;
    }

    .card-footer {
      padding: 1rem;
    }

    .medication-item {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .medication-actions {
      opacity: 1;
      align-self: flex-end;
    }
  }
</style>

<script>
  class MedicationCardComponent {
    constructor(containerId = 'medicationCard') {
      this.container = document.getElementById(containerId);
      this.medications = [];
      this.medicationHistory = [];
      this.init();
    }

    init() {
      if (!this.container) return;
      
      this.loadMedications();
      this.loadMedicationHistory();
      this.setupEventListeners();
      this.renderMedications();
      this.updateStats();
    }

    loadMedications() {
      this.medications = HealthSyncUtils.getItem('medications') || [];
      
      // Add sample data if empty
      if (this.medications.length === 0) {
        this.medications = [
          {
            id: 1,
            name: 'Metformin',
            dosage: '500mg',
            frequency: 'twice',
            time: '08:00',
            instructions: 'Take with breakfast'
          },
          {
            id: 2,
            name: 'Atenolol',
            dosage: '25mg',
            frequency: 'once',
            time: '20:00',
            instructions: 'Take at bedtime'
          }
        ];
        HealthSyncUtils.setItem('medications', this.medications);
      }
    }

    loadMedicationHistory() {
      this.medicationHistory = HealthSyncUtils.getItem('medication_history') || [];
    }

    setupEventListeners() {
      // Add medication button
      const addBtn = this.container.querySelector('#addMedication');
      if (addBtn) {
        addBtn.addEventListener('click', () => {
          this.showAddModal();
        });
      }

      // Refresh button
      const refreshBtn = this.container.querySelector('#refreshMeds');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          this.refreshMedications();
        });
      }

      // Modal event listeners
      this.setupModalEvents();
    }

    setupModalEvents() {
      const modal = document.getElementById('medicationModal');
      const closeBtn = document.getElementById('closeModal');
      const cancelBtn = document.getElementById('cancelMedication');
      const form = document.getElementById('medicationForm');

      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          this.hideAddModal();
        });
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          this.hideAddModal();
        });
      }

      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleAddMedication(form);
        });
      }

      // Close modal when clicking outside
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            this.hideAddModal();
          }
        });
      }
    }

    renderMedications() {
      const listContainer = document.getElementById('medicationsList');
      if (!listContainer) return;

      if (this.medications.length === 0) {
        listContainer.innerHTML = `
          <div class="no-medications">
            <div class="no-medications-icon">ðŸ’Š</div>
            <h4>No Medications</h4>
            <p>Add your first medication to get started with reminders.</p>
            <button class="btn-primary" onclick="medicationCard.showAddModal()">Add First Medication</button>
          </div>
        `;
        return;
      }

      const today = new Date().toDateString();
      const takenToday = this.medicationHistory.filter(record => 
        new Date(record.timestamp).toDateString() === today
      ).map(record => record.medicationId);

      listContainer.innerHTML = this.medications.map(med => `
        <div class="medication-item ${takenToday.includes(med.id) ? 'taken' : ''}" data-id="${med.id}">
          <div class="medication-checkbox ${takenToday.includes(med.id) ? 'checked' : ''}" 
               onclick="medicationCard.toggleMedication(${med.id})">
            ${takenToday.includes(med.id) ? 'âœ“' : ''}
          </div>
          <div class="medication-info">
            <div class="medication-name">${med.name}</div>
            <div class="medication-details">
              <span class="medication-dosage">${med.dosage}</span>
              <span class="medication-frequency">${this.getFrequencyText(med.frequency)}</span>
              <span class="medication-time">${med.time}</span>
            </div>
            ${med.instructions ? `<div class="medication-instructions">${med.instructions}</div>` : ''}
          </div>
          <div class="medication-actions">
            <button class="btn-small" onclick="medicationCard.editMedication(${med.id})">Edit</button>
            <button class="btn-small" onclick="medicationCard.deleteMedication(${med.id})">Delete</button>
          </div>
        </div>
      `).join('');

      // Update pill count
      const pillCount = document.getElementById('pillCount');
      if (pillCount) {
        pillCount.textContent = this.medications.length;
      }
    }

    getFrequencyText(frequency) {
      const frequencyMap = {
        once: 'Once daily',
        twice: 'Twice daily',
        thrice: 'Three times daily',
        weekly: 'Weekly',
        as_needed: 'As needed'
      };
      return frequencyMap[frequency] || frequency;
    }

    updateStats() {
      const today = new Date().toDateString();
      
      // Calculate taken today
      const takenToday = this.medicationHistory.filter(record => 
        new Date(record.timestamp).toDateString() === today
      ).length;

      // Calculate due today (simplified - all medications are due)
      const dueToday = this.medications.length;

      // Calculate adherence rate (last 7 days)
      const lastWeek = new Date();
      lastWeek.setDate(lastWeek.getDate() - 7);
      
      const recentHistory = this.medicationHistory.filter(record => 
        new Date(record.timestamp) >= lastWeek
      );
      
      const expectedDoses = this.medications.length * 7; // Simplified calculation
      const adherenceRate = expectedDoses > 0 ? 
        Math.round((recentHistory.length / expectedDoses) * 100) : 0;

      // Update DOM elements
      const takenElement = document.getElementById('takenToday');
      const dueElement = document.getElementById('dueToday');
      const adherenceElement = document.getElementById('adherenceRate');

      if (takenElement) takenElement.textContent = takenToday;
      if (dueElement) dueElement.textContent = dueToday;
      if (adherenceElement) adherenceElement.textContent = `${adherenceRate}%`;
    }

    toggleMedication(medicationId) {
      const today = new Date().toDateString();
      const existingRecordIndex = this.medicationHistory.findIndex(record => 
        record.medicationId === medicationId && 
        new Date(record.timestamp).toDateString() === today
      );

      if (existingRecordIndex > -1) {
        // Remove record (untake medication)
        this.medicationHistory.splice(existingRecordIndex, 1);
      } else {
        // Add record (take medication)
        this.medicationHistory.push({
          medicationId: medicationId,
          timestamp: new Date().toISOString()
        });
      }

      HealthSyncUtils.setItem('medication_history', this.medicationHistory);
      this.renderMedications();
      this.updateStats();

      // Show notification
      this.showNotification(
        existingRecordIndex > -1 ? 'Medication marked as not taken' : 'Medication marked as taken!'
      );
    }

    showAddModal() {
      const modal = document.getElementById('medicationModal');
      if (modal) {
        modal.classList.add('show');
        document.getElementById('medicationForm').reset();
      }
    }

    hideAddModal() {
      const modal = document.getElementById('medicationModal');
      if (modal) {
        modal.classList.remove('show');
      }
    }

    handleAddMedication(form) {
      const formData = {
        id: Date.now(),
        name: document.getElementById('medName').value,
        dosage: document.getElementById('medDosage').value,
        frequency: document.getElementById('medFrequency').value,
        time: document.getElementById('medTime').value,
        instructions: document.getElementById('medInstructions').value
      };

      // Validate required fields
      if (!formData.name || !formData.dosage || !formData.frequency || !formData.time) {
        this.showNotification('Please fill in all required fields', 'error');
        return;
      }

      this.medications.push(formData);
      HealthSyncUtils.setItem('medications', this.medications);
      
      this.hideAddModal();
      this.renderMedications();
      this.updateStats();
      this.showNotification('Medication added successfully!');
    }

    editMedication(medicationId) {
      // In a real app, this would open an edit modal
      this.showNotification('Edit feature coming soon!');
    }

    deleteMedication(medicationId) {
      if (confirm('Are you sure you want to delete this medication?')) {
        this.medications = this.medications.filter(med => med.id !== medicationId);
        HealthSyncUtils.setItem('medications', this.medications);
        
        // Also remove from history
        this.medicationHistory = this.medicationHistory.filter(record => 
          record.medicationId !== medicationId
        );
        HealthSyncUtils.setItem('medication_history', this.medicationHistory);
        
        this.renderMedications();
        this.updateStats();
        this.showNotification('Medication deleted successfully!');
      }
    }

    refreshMedications() {
      const refreshBtn = this.container.querySelector('#refreshMeds');
      if (refreshBtn) {
        refreshBtn.style.animation = 'spin 1s linear';
        setTimeout(() => {
          refreshBtn.style.animation = '';
        }, 1000);
      }

      // Reload data
      this.loadMedications();
      this.loadMedicationHistory();
      this.renderMedications();
      this.updateStats();
      
      this.showNotification('Medications refreshed!');
    }

    showNotification(message, type = 'success') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `medication-notification ${type}`;
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'error' ? '#ff6b6b' : '#51cf66'};
        color: white;
        border-radius: 8px;
        box-shadow: var(--shadow-hover);
        z-index: 1001;
        font-weight: 500;
        animation: slideInRight 0.3s ease;
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }
  }

  // Add CSS animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  `;
  document.head.appendChild(style);

  // Initialize component
  let medicationCard;
  document.addEventListener('DOMContentLoaded', () => {
    medicationCard = new MedicationCardComponent();
  });
</script>